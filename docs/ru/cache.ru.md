# Что на самом деле представляет собой кэш?
```Go
type LRUCache struct {
	mu             sync.RWMutex
	entryCountCap  int // максимальное количество записей
	entrySizeCap   int // максимальный размер одной записи
	currEntryCount int
	items          map[string]*list.Element
	evictList      *list.List
}
```
По сути, он состоит из:
- `RWmutex` для обеспечения потокобезопасности.
- `entryCountCap` — это ограничение на общее количество записей в кэше.
- `entrySizeCap` — это ограничение на размер одной записи, созданное для предотвращения 'poison pills', которые, по сути, являются валидными данными, но имеют размер сильно больше ожидаемого (например, заказ в котором 100 000 товаров). Таким образом, эта опция существует в основном для предотвращения подобных ситуаций.
- `items` хранит указатели на элементы двусвязного списка, что обеспечивает доступ к любому элементу за O(1)
- `evictList` — это двусвязный список, который позволяет вставлять и удалять элементы в начале и в конце за O(1)

Изначально я не мог решить, как ограничивать кэш: по объему памяти или по количеству записей?
* В первом случае малое количество очень больших заказов может заполнить большую часть кэша
* Во втором случае проблема обратная: записей точно будет столько, сколько мы выставим в ограничениях, но кэш может быть только опредленного размера
* Поэтому я решил использовать 'гибрид', в котором ограничено и то, и другое. Такой способ тоже имеет недостатки, например, память может недоиспользоваться, если заказы сильно меньше ожидаемых (его нельзя назвать 'лучшим' в каком-то объективном смысле, но мне понравилось его делать).

В итоге имеем следующее:
*   Ограничение по объему памяти может привести к тому, что кэш будет хранить меньше записей, чем следовало бы.
*   Ограничение по количеству записей не позволяет точно знать размер кэша.
*   Гибридный подход проверяет размеры записей, т.е. тратит время при вставке в кэш, и может недоиспользовать ресурсы памяти.

Для вычисления размера я не смог найти библиотек, поэтому написал такую [функцию для подсчета полного размера записей в кэше](../internal/pkg/sizeof/calculator.go).
